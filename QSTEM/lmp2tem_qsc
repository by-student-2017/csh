#! /bin/csh -f
set filename = $1
cp ${filename}.cfg tmp.cfg
#
set x = `awk '{if($1 == "H0(1,1)"){print $3 }}' tmp.cfg`
set y = `awk '{if($1 == "H0(2,2)"){print $3 }}' tmp.cfg`
set z = `awk '{if($1 == "H0(3,3)"){print $3 }}' tmp.cfg`
#
# calculate number of slices
set thickness = ${z}
#
set slices = `echo ${thickness} | awk '{printf("%d",$1/2.0+0.5)}'`
set slice_thickness = `echo "${thickness} ${slices}" | awk '{printf("%f",$1/$2)}'`
#echo ${thickness}
#echo ${slices}
#
if ("$2" == "-kv") then
  set v0 = `echo $3 | awk '{printf("%11.6f",$1)}'`
else if ("$3" == "-kv") then
  set v0 = `echo $4 | awk '{printf("%11.6f",$1)}'`
else if ("$4" == "-kv") then
  set v0 = `echo $5 | awk '{printf("%11.6f",$1)}'`
else if ("$5" == "-kv") then
  set v0 = `echo $6 | awk '{printf("%11.6f",$1)}'`
else if ("$6" == "-kv") then
  set v0 = `echo $7 | awk '{printf("%11.6f",$1)}'`
else if ("$7" == "-kv") then
  set v0 = `echo $8 | awk '{printf("%11.6f",$1)}'`
else if ("$8" == "-kv") then
  set v0 = `echo $9 | awk '{printf("%11.6f",$1)}'`
else
  set v0 = 200.000000
endif
set lambda = `echo ${v0} | awk '{printf("%12.10f",12.26/10.0/(($1*10^3*(1+0.9788*10^-3*$1))^(1/2)))}'`
set defocus = `echo ${lambda} | awk '{printf("%f",-1.2*(1.0*$1)^(1/2)*1000)}'`
#echo ${lambda}
#echo ${defocus}
set resolutionX = `echo ${x} | awk '{printf("%f",$1/512)}'`
set resolutionY = `echo ${y} | awk '{printf("%f",$1/512)}'`
#
if ("$2" == "-autoz" || "$3" == "-autoz" || "$4" == "-autoz" || "$5" == "-autoz" || "$6" == "-autoz" || "$7" == "-autoz" || "$8" == "-autoz" || "$9" == "-autoz" || "${10}" == "-autoz") then
  set zOffset = `echo ${slice_thickness} | awk '{printf("%f",$1/2)}'`
else
  set zOffset = 0.000000
endif

if ("$2" == "-lab6" || "$3" == "-lab6" || "$4" == "-lab6" || "$5" == "-lab6" || "$6" == "-lab6" || "$7" == "-lab6" || "$8" == "-lab6" || "$9" == "-lab6" || "${10}" == "-lab6") then
  set dVV = `echo ${v0} | awk '{printf("%f",1.5/($1*1000))}'`
  set Cs  = 1.00000
  set Cc  = 1.400000
  set alpha = 15.0 # 1.5 - 20 [mrad]
  set Source_Size = 10
  set beam_current = 20 
else if ("$2" == "-fe" || "$3" == "-fe" || "$4" == "-fe" || "$5" == "-fe" || "$6" == "-fe" || "$7" == "-fe" || "$8" == "-fe" || "$9" == "-fe" || "${10}" == "-fe") then
  set dVV = `echo ${v0} | awk '{printf("%f",0.65/($1*1000))}'`
  set Cs  = 1.00000
  set Cc  = 1.400000
  set alpha = 1.5 # 1.5 - 20 [mrad]
  set Source_Size = 2
  set beam_current = 20 
else if ("$2" == "-arm" || "$3" == "-arm" || "$4" == "-arm" || "$5" == "-arm" || "$6" == "-arm" || "$7" == "-arm" || "$8" == "-arm" || "$9" == "-arm" || "${10}" == "-arm") then
  set dVV = `echo ${v0} | awk '{printf("%f",0.325/($1*1000))}'`
  set Cs  = 1.00000
  set Cc  = 1.400000
  set alpha = 1.5 # 1.5 - 20 [mrad]
  set Source_Size = 1
  set beam_current = 20 
else
  set dVV = 0.000003
  set Cs  = 1.00000
  set Cc  = 1.000000
  set alpha = 1.5 # 1.5 - 20 [mrad]
  set Source_Size = 0
  set beam_current = 1 
endif

if ("$2" == "-tds" || "$3" == "-tds" || "$4" == "-tds" || "$5" == "-tds" || "$6" == "-tds" || "$7" == "-tds" || "$8" == "-tds" || "$9" == "-tds" || "${10}" == "-tds") then
  set tds = "yes"
else
  set tds = "no"
endif

cat << EOF > tem.qsc
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% STEM configuration file generated by qstem
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

mode: TEM
print level: 4  % indicates how much information in output
save level:  3  % indicates how much information shall be saved 
filename: ${filename}.cfg 
resolutionX:  ${resolutionX}
resolutionY:  ${resolutionY}
NCELLX: 1
NCELLY: 1
NCELLZ: 1
v0: ${v0}  % beam energy
tds: ${tds} % do NOT include thermal diffuse scattering
temperature: 298.000000	% temperature in Kelvin 
slice-thickness: ${slice_thickness}  % slice thckness in A
slices: ${slices}		% number of different slices per slab in z-direction
center slices: no       % do not center slices
slices between outputs: 10  % give intermediate results after every 8 slices
xOffset:  0.000000      % slize x-position offset in cartesian coords
yOffset:  0.000000      % slize y-position offset in cartesian coords
zOffset:  ${zOffset}      % slize z-position offset in cartesian coords
periodicXY: no		% not periodic in x- and y-direction
periodicZ: no		% not periodic in z-direction

% Geometrical properties 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

Crystal tilt X: 0.000000	% tilt in rad 
Crystal tilt Y: 0.000000  
Crystal tilt Z: 0.000000  
Beam tilt X: 0.0	% beam tilt in mrad 
Beam tilt Y: 0.0
Tilt back: no 

% TEM imaging parameters 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

nx: 512		% array size used for probe 
ny: 512         % ny = nx, if not specified
Cs: ${Cs}       % Speherical abberation in mm
C5: 0.000000	% C_5 abberation in mm
Cc: ${Cc}	% Chromatic abberation in mm
dV/V: ${dVV}	% energy spread in eV (FWHM)
alpha: ${alpha}	 % Illumination angle in mrad
defocus: ${defocus}	
astigmatism: 0.000000	
astigmatism angle: 0.000000	


Source Size (diameter): ${Source_Size}  % source size in A
beam current: ${beam_current}        % beam current in pA (default: 1)
dwell time: 1000        % dwell time in msec (default: 1) (GUI 1.6021773e-4)
smooth: yes		% smoothen edge of probe in rec. space
gaussian: no		
% Parameters for potential calculation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

potential3D:          yes  % use 3D or 2D potential (3D realistically simulates z-motion of atoms)
atom radius:          5.0	% radius used for calculation of proj potential V_proj(r)
plot V(r)*r:          no	% will create a plot for V_proj(r)*r vs. r  for all slices and 1st atom
bandlimit f_trans:    no	% indicate whether to band limit transmission function or not
save potential:       no	% whether we want to save the projected potential in files
save projected potential:       yes	% whether we want to save the total projected potential
one time integration: yes  % calculate V_proj once and then copy (much faster) 
Display Gamma: 0     % Gamma value for image scaling (0 = logarithmic)
Folder: "${filename}"
Runs for averaging: 30  % averaging over 30 images for TDS simulation
Structure Factors: WK
show Probe: no		% displays a graph of the crosssection of the inc. e-beam
propagation progress interval: 10 % show progress every N_prop_prog beam positions
potential progress interval: 1000 % show progress every N_pot_prog atoms
update Web: no		% put results on web page
Pendelloesung plot: no  % flag indicates whether to store Pendeloesung plot
sequence: 1 1
EOF

